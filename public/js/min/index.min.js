window.addEventListener("load",()=>{let CURRENT_LOCATION;"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!0);var map=L.map("map").fitWorld();let TILESLAYER_DATA={url:["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}","https://{s}.tile.osm.org/{z}/{x}/{y}.png","https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png"],defaultIndex:localStorage.getItem("layerMap")?localStorage.getItem("layerMap"):0};function onLocationFound(e){L.circle(e.latlng,{color:"red",fillColor:"red",fillOpacity:1,radius:5}).addTo(map),CURRENT_LOCATION=e.latlng}function onLocationError(e){map.setView([39.4636864,-.3637378],14)}L.tileLayer(TILESLAYER_DATA.url[TILESLAYER_DATA.defaultIndex],{maxZoom:19,attribution:"©"}).addTo(map),map.locate({setView:!0,maxZoom:16}),map.on("locationfound",onLocationFound),map.on("locationerror",onLocationError);let search_data_inputDOM=document.getElementById("search-data"),search_dataDOM=document.querySelector(".search_data"),search_data_listDOM=search_dataDOM.querySelector(".data_content_list");const close_search_tab=()=>{search_dataDOM.classList.remove("active"),search_data_inputDOM.value="",search_data_listDOM.innerHTML=""};let ROUTE;search_data_inputDOM.addEventListener("keyup",()=>{0==search_data_inputDOM.value.length?close_search_tab():fetch("/api/search/"+search_data_inputDOM.value,{method:"GET",headers:{"Content-Type":"application/json"}}).then(res=>res.json()).then(data=>{search_dataDOM.classList.add("active"),search_data_listDOM.innerHTML="",data.forEach(elements=>{elements.forEach(element=>{search_data_listDOM.innerHTML+=`\n                            <div class="data_content border-radius drop-shadow">\n                                <span>${element.Name}</span>\n                            </div>\n                        `})}),console.log(JSON.stringify(data,null,2))})});let new_routeDATA={active:!0,scrollTop:!0,enableScroll:!1,posY:0},new_routeDOM=document.getElementById("new_route"),new_routeLineDom=new_routeDOM.querySelector(".route_line");const new_route_windowHeight=.15*window.innerHeight||new_routeDOM.getBoundingClientRect().top;let touchFnc_touchStart=(e,el,data)=>{el.style.transition="none",data.posY=e.touches[0].clientY},touchFnc_touchMove=(e,el)=>{e.preventDefault();let touch=e.touches[0];touch.pageY>new_route_windowHeight&&(el.style.top=touch.clientY-25+"px")},touchFnc_touchEnd=(e,el,data,disable=!1)=>{el.style.transition="top 0.3s ease-out",e.preventDefault();let touch=e.changedTouches[0];Math.abs(touch.clientY-data.posY)>50?(data.active&&touch.clientY>data.posY?el.style.top=disable?window.innerHeight+"px":.85*window.innerHeight+"px":el.style.top=.15*window.innerHeight+"px",data.active=!data.active):data.active?el.style.top=.15*window.innerHeight+"px":el.style.top=.85*window.innerHeight+"px"};new_routeLineDom.addEventListener("touchstart",e=>touchFnc_touchStart(e,new_routeDOM,new_routeDATA)),new_routeLineDom.addEventListener("touchmove",e=>touchFnc_touchMove(e,new_routeDOM)),new_routeLineDom.addEventListener("touchend",e=>touchFnc_touchEnd(e,new_routeDOM,new_routeDATA,!1));let new_routeSearchDATA={active:!0,scrollTop:!0,enableScroll:!1,posY:0},new_routeSearchDOM=document.getElementById("new_route_search"),new_routeSearchLineDom=new_routeSearchDOM.querySelector(".route_line");new_routeSearchLineDom.addEventListener("touchstart",e=>touchFnc_touchStart(e,new_routeSearchDOM,new_routeSearchDATA)),new_routeSearchLineDom.addEventListener("touchmove",e=>touchFnc_touchMove(e,new_routeSearchDOM)),new_routeSearchLineDom.addEventListener("touchend",e=>touchFnc_touchEnd(e,new_routeSearchDOM,new_routeSearchDATA,!0));let new_route_btn=document.getElementById("btn_new_route"),preference_back_btn=document.getElementById("preference_back_btn"),preference_btn=document.getElementById("btn_preference"),add_favourite_back_btn=document.getElementById("add_favourite_back_btn"),add_favourite_btn=document.getElementById("btn_add_favourite"),preferenceDOM=document.getElementById("preference"),add_favouriteDOM=document.getElementById("add_favourite");new_route_btn.addEventListener("click",e=>{new_routeSearchDOM.style.transition="top 0.3s ease-in-out",e.preventDefault(),new_routeSearchDOM.style.top=.15*window.innerHeight+"px"}),preference_btn.addEventListener("click",e=>{e.preventDefault(),preferenceDOM.classList.add("active")}),add_favourite_btn.addEventListener("click",e=>{e.preventDefault(),add_favouriteDOM.classList.add("active")}),preference_back_btn.addEventListener("click",e=>{e.preventDefault(),preferenceDOM.classList.remove("active")}),add_favourite_back_btn.addEventListener("click",e=>{e.preventDefault(),add_favouriteDOM.classList.remove("active")});const createRandomRoute=()=>{ROUTE&&ROUTE.spliceWaypoints(0,5),fetch("/api/random",{method:"GET",headers:{"Content-Type":"application/json"}}).then(res=>res.json()).then(res=>{ROUTE=L.Routing.control({waypoints:[CURRENT_LOCATION,L.latLng(res[0].la,res[0].lo),L.latLng(res[2].la,res[2].lo),L.latLng(res[1].la,res[1].lo)],routeWhileDragging:!1,serviceUrl:"https://router.project-osrm.org/route/v1"}).addTo(map),console.log(JSON.stringify(res,null,2)),document.getElementById("return-data").textContent=JSON.stringify(res,null,2)})};let create_routeDOM,return_homeDOM,locate_user,repeat_route,map_layer_arr;document.getElementById("create_route").addEventListener("click",e=>{close_search_tab(),e.preventDefault(),new_routeDOM.style.transition="top 0.5s ease-in-out",new_routeSearchDOM.style.transition="top 0.5s ease-in-out",new_routeSearchDOM.style.top=window.innerHeight+"px",new_routeDOM.style.top=.15*window.innerHeight+"px",document.querySelectorAll(".active-route").forEach(el=>el.classList.add("active")),createRandomRoute()}),document.getElementById("return-home").addEventListener("click",e=>{e.preventDefault(),new_routeDOM.style.transition="top 0.5s ease-in-out",new_routeDOM.style.top=window.innerHeight+"px",document.querySelectorAll(".active-route").forEach(el=>el.classList.remove("active")),ROUTE.spliceWaypoints(0,5),map.locate({setView:!0,maxZoom:16})}),document.getElementById("locate-user").addEventListener("click",e=>{e.preventDefault(),map.locate({setView:!0,maxZoom:16})}),document.getElementById("repeat-route").addEventListener("click",e=>{e.preventDefault(),createRandomRoute()}),document.querySelectorAll(".map-layer").forEach(el=>{el.addEventListener("click",e=>{e.preventDefault(),TILESLAYER_DATA.defaultIndex=el.getAttribute("data-layer"),localStorage.setItem("layerMap",TILESLAYER_DATA.defaultIndex),L.tileLayer(TILESLAYER_DATA.url[TILESLAYER_DATA.defaultIndex],{maxZoom:19,attribution:"©"}).addTo(map)})})});